<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Health Tracker | Calories & Water</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10b981">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/192/192451.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { water: '#3b82f6', 'water-dark': '#1d4ed8' }
                }
            }
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged,
            getFirestore, collection, onSnapshot, addDoc, serverTimestamp
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s ease; }
        .container-box { box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1); }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 24px; height: 24px; border-radius: 50%; border-left-color: #10b981; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .water-wave { background: linear-gradient(180deg, #3b82f6 0%, #1d4ed8 100%); transition: height 0.6s ease; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 p-4 md:p-8 min-h-screen text-slate-800 dark:text-slate-100">

    <div class="max-w-5xl mx-auto space-y-6">
        <header class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-extrabold tracking-tight">HealthDashboard</h1>
                <p class="text-sm text-slate-500 dark:text-slate-400">AI Powered Personal Wellness</p>
            </div>
            <button onclick="document.documentElement.classList.toggle('dark')" class="p-3 rounded-xl bg-white dark:bg-slate-800 shadow-sm border border-slate-200 dark:border-slate-700">
                ðŸŒ“
            </button>
        </header>

        <!-- Stats Row -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl container-box border border-slate-100 dark:border-slate-700">
                <p class="text-sm font-semibold text-slate-500 uppercase">Calories Today</p>
                <div class="flex items-baseline gap-2 mt-2">
                    <span id="dailyTotalCalories" class="text-4xl font-bold text-emerald-600">0</span>
                    <span class="text-slate-400 text-lg">kcal</span>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl container-box border border-slate-100 dark:border-slate-700 relative overflow-hidden">
                <div class="relative z-10">
                    <p class="text-sm font-semibold text-slate-500 uppercase">Water Intake</p>
                    <div class="flex items-baseline gap-2 mt-2">
                        <span id="dailyWaterTotal" class="text-4xl font-bold text-blue-600">0</span>
                        <span class="text-slate-400 text-lg">/ 2500 ml</span>
                    </div>
                </div>
                <div id="waterFill" class="absolute bottom-0 left-0 w-full water-wave opacity-10" style="height: 0%"></div>
            </div>

            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl container-box border border-slate-100 dark:border-slate-700 flex flex-col justify-center">
                <div class="flex items-center gap-2 mb-1">
                    <div id="statusIndicator" class="w-2 h-2 rounded-full bg-slate-300"></div>
                    <span id="authStatus" class="text-xs font-bold text-slate-400 uppercase">Connecting...</span>
                </div>
                <span id="displayUserId" class="text-[10px] font-mono text-slate-400 truncate">No User</span>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <!-- Meal Input -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl container-box border border-slate-100 dark:border-slate-700">
                    <h2 class="text-xl font-bold mb-4">ðŸ“¸ Log Meal with AI</h2>
                    <input type="text" id="mealNameInput" class="w-full p-4 mb-4 bg-slate-50 dark:bg-slate-700 border rounded-xl" placeholder="E.g. Chicken Biryani">
                    <div class="flex flex-col md:flex-row gap-4">
                        <input type="file" id="imageInput" accept="image/*" class="flex-1 text-sm text-slate-500">
                        <button id="submitButton" onclick="handleMealAnalysis()" class="px-8 py-3 bg-emerald-600 text-white font-bold rounded-xl shadow-lg">Analyze Meal</button>
                    </div>
                    <div id="outputContainer" class="hidden mt-4 p-4 bg-slate-50 dark:bg-slate-700 rounded-xl">
                        <div id="loadingIndicator" class="hidden flex items-center gap-2">
                            <div class="spinner"></div><span>AI is thinking...</span>
                        </div>
                        <div id="aiResponse" class="text-sm"></div>
                    </div>
                </div>

                <!-- Water Log -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl container-box border border-slate-100 dark:border-slate-700">
                    <h2 class="text-xl font-bold mb-4">ðŸ’§ Water</h2>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="logWater(250)" class="p-3 bg-blue-50 dark:bg-blue-900/30 text-blue-600 rounded-xl">+250ml</button>
                        <button onclick="logWater(500)" class="p-3 bg-blue-50 dark:bg-blue-900/30 text-blue-600 rounded-xl">+500ml</button>
                        <button onclick="logWater(750)" class="p-3 bg-blue-50 dark:bg-blue-900/30 text-blue-600 rounded-xl">+750ml</button>
                        <button onclick="logWater(1000)" class="p-3 bg-blue-50 dark:bg-blue-900/30 text-blue-600 rounded-xl">+1L</button>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl container-box border border-slate-100 dark:border-slate-700">
                    <h2 class="text-lg font-bold mb-4">Trends</h2>
                    <div class="h-48"><canvas id="calorieChart"></canvas></div>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl container-box border border-slate-100 dark:border-slate-700">
                <h2 class="text-xl font-bold mb-4">Recent</h2>
                <div id="activityFeed" class="space-y-3"></div>
            </div>
        </div>

        <div class="p-4 bg-black rounded-lg text-emerald-500 font-mono text-[10px] opacity-75">
            <p>> SYSTEM LOG: <span id="debugLog">Ready...</span></p>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const apiKey = "AIzaSyCRNuWwasPuuxXzyUGE_ldUZmf78Y5miPI"; 
        const firebaseConfig = {
            apiKey: "AIzaSyBdlf1ufGZNTWxcO9vTDYqGSEz8uBRRaOw",
            authDomain: "my-health-tracker-6a42c.firebaseapp.com",
            projectId: "my-health-tracker-6a42c",
            storageBucket: "my-health-tracker-6a42c.firebasestorage.app",
            messagingSenderId: "440721276125",
            appId: "1:440721276125:web:1c3566058a8ba1bef62f34"
        };

        const appId = 'my-health-tracker-6a42c';
        let db, auth, userId = null, chartInstance;

        function logDebug(msg) { document.getElementById('debugLog').innerText = msg; }

        async function init() {
            if (!window.firebase) return;
            const app = window.firebase.initializeApp(firebaseConfig);
            db = window.firebase.getFirestore(app);
            auth = window.firebase.getAuth(app);

            await window.firebase.signInAnonymously(auth);
            window.firebase.onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('displayUserId').innerText = userId;
                    document.getElementById('authStatus').innerText = "ONLINE";
                    document.getElementById('statusIndicator').className = "w-2 h-2 rounded-full bg-emerald-500";
                    logDebug("Connected to Firebase.");
                    startListeners();
                }
            });
        }

        function startListeners() {
            const today = new Date().toISOString().split('T')[0];
            const mealsRef = window.firebase.collection(db, 'artifacts', appId, 'users', userId, 'meals');
            window.firebase.onSnapshot(mealsRef, (snap) => {
                let total = 0;
                const items = [];
                snap.forEach(doc => {
                    const data = doc.data();
                    if (data.dateKey === today) {
                        total += data.calories;
                        items.push(data);
                    }
                });
                document.getElementById('dailyTotalCalories').innerText = total;
                renderFeed(items);
            });

            const waterRef = window.firebase.collection(db, 'artifacts', appId, 'users', userId, 'water');
            window.firebase.onSnapshot(waterRef, (snap) => {
                let total = 0;
                snap.forEach(doc => { if (doc.data().dateKey === today) total += doc.data().amount; });
                document.getElementById('dailyWaterTotal').innerText = total;
                document.getElementById('waterFill').style.height = Math.min((total/2500)*100, 100) + '%';
            });
        }

        async function logWater(amount) {
            if (!userId) return;
            await window.firebase.addDoc(window.firebase.collection(db, 'artifacts', appId, 'users', userId, 'water'), {
                amount, dateKey: new Date().toISOString().split('T')[0], createdAt: window.firebase.serverTimestamp()
            });
        }

        async function handleMealAnalysis() {
            const name = document.getElementById('mealNameInput').value;
            const file = document.getElementById('imageInput').files[0];
            if (!name || !file) return alert("Enter meal name and photo.");

            document.getElementById('outputContainer').classList.remove('hidden');
            document.getElementById('loadingIndicator').classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = e.target.result.split(',')[1];
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        body: JSON.stringify({ contents: [{ parts: [
                            { text: "Estimate calories for this meal. Return exactly: [CALORIES: XXX]" },
                            { inlineData: { mimeType: file.type, data: base64 } }
                        ]}]})
                    });
                    const data = await res.json();
                    const text = data.candidates[0].content.parts[0].text;
                    const cals = parseInt(text.match(/\[CALORIES:\s*(\d+)\]/)[1]);
                    
                    document.getElementById('aiResponse').innerHTML = marked.parse(text);
                    await window.firebase.addDoc(window.firebase.collection(db, 'artifacts', appId, 'users', userId, 'meals'), {
                        name, calories: cals, dateKey: new Date().toISOString().split('T')[0], createdAt: window.firebase.serverTimestamp()
                    });
                    logDebug("Meal Logged!");
                } catch (err) { logDebug("AI Error: " + err.message); }
                document.getElementById('loadingIndicator').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        function renderFeed(items) {
            const feed = document.getElementById('activityFeed');
            feed.innerHTML = items.map(i => `<div class="p-3 bg-slate-50 dark:bg-slate-700 rounded-lg flex justify-between"><b>${i.name}</b><span>${i.calories} kcal</span></div>`).join('');
        }

        window.onload = init;
    </script>
</body>
</html>
