<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Health Tracker | Calories & Water</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10b981">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/192/192451.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, query, orderBy, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
            getFirestore, collection, onSnapshot, addDoc, serverTimestamp, query, orderBy, doc, setDoc
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .container-box { box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .spinner { border: 3px solid rgba(16, 185, 129, 0.2); border-top: 3px solid #10b981; border-radius: 50%; width: 20px; height: 20px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .water-wave { background: #3b82f6; transition: height 1s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 p-4 min-h-screen text-slate-800 dark:text-slate-100">

    <div class="max-w-4xl mx-auto space-y-6">
        <header class="flex justify-between items-center bg-white dark:bg-slate-800 p-4 rounded-2xl container-box">
            <div>
                <h1 class="text-2xl font-bold text-emerald-600">HealthAI</h1>
                <p class="text-xs text-slate-400">Personal Nutrition Assistant</p>
            </div>
            <div class="text-right">
                <div class="flex items-center gap-2 justify-end">
                    <div id="statusIndicator" class="w-2 h-2 rounded-full bg-slate-300"></div>
                    <span id="authStatus" class="text-[10px] font-bold">OFFLINE</span>
                </div>
                <p id="displayUserId" class="text-[9px] font-mono text-slate-400">No Connection</p>
            </div>
        </header>

        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl container-box">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Today's Calories</p>
                <p class="text-3xl font-black text-emerald-600 mt-1"><span id="dailyTotalCalories">0</span></p>
            </div>

            <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl container-box relative overflow-hidden">
                <div class="relative z-10">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Hydration</p>
                    <p class="text-3xl font-black text-blue-600 mt-1"><span id="dailyWaterTotal">0</span> <span class="text-sm font-normal text-slate-400">ml</span></p>
                </div>
                <div id="waterFill" class="absolute bottom-0 left-0 w-full water-wave opacity-20" style="height: 0%"></div>
            </div>

            <div class="hidden md:block bg-white dark:bg-slate-800 p-5 rounded-2xl container-box">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Quick Status</p>
                <p class="text-sm mt-2 font-medium" id="goalStatus">Syncing data...</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <!-- AI Analysis -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl container-box border-2 border-emerald-500/20">
                    <h2 class="font-bold mb-4 flex items-center gap-2">ðŸ“· Instant AI Food Logger</h2>
                    <div class="space-y-3">
                        <input type="text" id="mealNameInput" class="w-full p-3 bg-slate-100 dark:bg-slate-700 rounded-xl outline-none focus:ring-2 ring-emerald-500" placeholder="Describe the meal (e.g. Rice and Chicken)">
                        
                        <div class="flex items-center gap-3">
                            <label class="flex-1 cursor-pointer bg-slate-100 dark:bg-slate-700 p-3 rounded-xl text-center text-sm font-medium hover:bg-slate-200 dark:hover:bg-slate-600 transition truncate">
                                <span id="fileStatus">ðŸ“¸ Tap to Take Photo</span>
                                <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="document.getElementById('fileStatus').innerText = 'Ready: ' + this.files[0].name.substring(0,10) + '...'">
                            </label>
                            <button id="submitButton" onclick="handleMealAnalysis()" class="px-8 py-3 bg-emerald-600 text-white font-bold rounded-xl active:scale-95 transition disabled:opacity-50 shadow-lg shadow-emerald-500/20">Analyze</button>
                        </div>
                    </div>
                    
                    <div id="outputContainer" class="hidden mt-4 p-4 bg-emerald-50 dark:bg-emerald-900/10 rounded-xl border border-emerald-100 dark:border-emerald-800/50">
                        <div id="loadingIndicator" class="hidden flex items-center gap-3 py-2">
                            <div class="spinner"></div>
                            <span class="text-xs font-bold text-emerald-600">AI is analyzing...</span>
                        </div>
                        <div id="aiResponse" class="text-xs leading-relaxed prose prose-sm dark:prose-invert max-w-none"></div>
                    </div>
                </div>

                <!-- Water Log -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl container-box">
                    <h2 class="font-bold mb-4">ðŸ’§ Hydration Log</h2>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="logWater(250)" class="p-3 bg-blue-50 dark:bg-blue-900/30 text-blue-600 font-bold rounded-xl">+250</button>
                        <button onclick="logWater(500)" class="p-3 bg-blue-50 dark:bg-blue-900/30 text-blue-600 font-bold rounded-xl">+500</button>
                        <button onclick="logWater(750)" class="p-3 bg-blue-50 dark:bg-blue-900/30 text-blue-600 font-bold rounded-xl">+750</button>
                        <button onclick="logWater(1000)" class="p-3 bg-blue-50 dark:bg-blue-900/30 text-blue-600 font-bold rounded-xl">+1L</button>
                    </div>
                </div>

                <!-- History Chart -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl container-box">
                    <h2 class="font-bold mb-4">7-Day Progress</h2>
                    <div class="h-64 w-full"><canvas id="calorieChart"></canvas></div>
                </div>
            </div>

            <!-- Side Log -->
            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl container-box">
                <h2 class="font-bold mb-4">Activity Log</h2>
                <div id="activityFeed" class="space-y-3 max-h-[600px] overflow-y-auto pr-1">
                    <p class="text-xs text-slate-400 text-center py-10 italic">Your logged meals will appear here</p>
                </div>
            </div>
        </div>

        <div class="p-3 bg-slate-900 rounded-xl text-emerald-500 font-mono text-[9px] overflow-hidden flex justify-between">
            <span>> SYSTEM: <span id="debugLog">Ready</span></span>
            <span id="speedLog" class="text-slate-500"></span>
        </div>
    </div>

    <script>
        // CONFIG
        const apiKey = ""; // EMPTY STRING FOR PREVIEW ENVIRONMENT (Provided at runtime)
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let db, auth, userId = null, chartInstance = null;

        function logDebug(msg) { document.getElementById('debugLog').innerText = msg; }

        async function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 600;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6).split(',')[1]);
                    };
                };
            });
        }

        async function init() {
            try {
                const app = window.firebase.initializeApp(firebaseConfig);
                db = window.firebase.getFirestore(app);
                auth = window.firebase.getAuth(app);
                
                initChart();

                // Auth Logic (Rule 3)
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await window.firebase.signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await window.firebase.signInAnonymously(auth);
                    }
                };
                initAuth();

                window.firebase.onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('displayUserId').innerText = userId;
                        document.getElementById('authStatus').innerText = "ONLINE";
                        document.getElementById('statusIndicator').className = "w-2 h-2 rounded-full bg-emerald-500";
                        logDebug("Connected.");
                        startListeners();
                    }
                });
            } catch (e) { logDebug("Init Error: " + e.message); }
        }

        function startListeners() {
            if (!userId) return;
            const today = new Date().toISOString().split('T')[0];
            const mealsRef = window.firebase.collection(db, 'artifacts', appId, 'users', userId, 'meals');
            
            window.firebase.onSnapshot(mealsRef, (snap) => {
                let todayTotal = 0;
                const items = [];
                const historyData = {};
                snap.forEach(doc => {
                    const data = doc.data();
                    const dKey = data.dateKey;
                    historyData[dKey] = (historyData[dKey] || 0) + (data.calories || 0);
                    if (dKey === today) {
                        todayTotal += (data.calories || 0);
                        items.push({ id: doc.id, ...data });
                    }
                });
                document.getElementById('dailyTotalCalories').innerText = todayTotal;
                updateChart(historyData);
                renderFeed(items);
                updateGoalStatus(todayTotal);
            }, (err) => logDebug("Sync Error: " + err.message));

            const waterRef = window.firebase.collection(db, 'artifacts', appId, 'users', userId, 'water');
            window.firebase.onSnapshot(waterRef, (snap) => {
                let total = 0;
                snap.forEach(doc => { if (doc.data().dateKey === today) total += (doc.data().amount || 0); });
                document.getElementById('dailyWaterTotal').innerText = total;
                document.getElementById('waterFill').style.height = Math.min((total/2500)*100, 100) + '%';
            });
        }

        function updateGoalStatus(total) {
            const goal = 2000;
            const remaining = goal - total;
            const el = document.getElementById('goalStatus');
            if (remaining > 0) {
                el.innerText = `${remaining} kcal left for goal`;
                el.className = "text-sm mt-2 font-medium text-slate-500";
            } else {
                el.innerText = "Goal Reached! ðŸš€";
                el.className = "text-sm mt-2 font-bold text-emerald-500";
            }
        }

        async function handleMealAnalysis() {
            if (!userId) return logDebug("User not authenticated.");
            const nameInput = document.getElementById('mealNameInput');
            const name = nameInput.value.trim();
            const file = document.getElementById('imageInput').files[0];
            
            if (!name || !file) return alert("Please type the meal name and select a photo.");

            const btn = document.getElementById('submitButton');
            btn.disabled = true;
            document.getElementById('outputContainer').classList.remove('hidden');
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('aiResponse').innerHTML = '';
            
            const startTime = Date.now();
            logDebug("Optimizing...");

            try {
                const optimizedBase64 = await compressImage(file);
                logDebug("AI analyzing...");
                
                let retryCount = 0;
                let responseText = "";
                
                // Exponential Backoff implementation
                const fetchWithRetry = async (attempt) => {
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [
                                        { text: `Estimate calories for this meal: "${name}". Be very brief. format with bullets. End with: [CALORIES: XXX]` },
                                        { inlineData: { mimeType: 'image/jpeg', data: optimizedBase64 } }
                                    ]
                                }]
                            })
                        });
                        
                        if (!res.ok) throw new Error(`API error ${res.status}`);
                        const data = await res.json();
                        return data.candidates?.[0]?.content?.parts?.[0]?.text;
                    } catch (err) {
                        if (attempt < 5) {
                            const delay = Math.pow(2, attempt) * 1000;
                            await new Promise(r => setTimeout(r, delay));
                            return fetchWithRetry(attempt + 1);
                        }
                        throw err;
                    }
                };

                responseText = await fetchWithRetry(0);
                
                if (!responseText) throw new Error("No response from AI");

                const calsMatch = responseText.match(/\[CALORIES:\s*(\d+)\]/);
                const cals = calsMatch ? parseInt(calsMatch[1]) : 0;
                
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                document.getElementById('speedLog').innerText = `Processed in ${duration}s`;
                
                document.getElementById('aiResponse').innerHTML = marked.parse(responseText);
                
                await window.firebase.addDoc(window.firebase.collection(db, 'artifacts', appId, 'users', userId, 'meals'), {
                    name, calories: cals, dateKey: new Date().toISOString().split('T')[0], createdAt: window.firebase.serverTimestamp()
                });
                
                logDebug("Success.");
                nameInput.value = '';
                document.getElementById('imageInput').value = null;
                document.getElementById('fileStatus').innerText = 'ðŸ“¸ Tap to Take Photo';
            } catch (err) {
                logDebug("Error: " + err.message);
                document.getElementById('aiResponse').innerHTML = `<p class="text-red-500 font-bold">Analysis Error: ${err.message}</p><p class="mt-2">Try refreshing or using a smaller image.</p>`;
            } finally {
                btn.disabled = false;
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        }

        async function logWater(amount) {
            if (!userId) return;
            await window.firebase.addDoc(window.firebase.collection(db, 'artifacts', appId, 'users', userId, 'water'), {
                amount, dateKey: new Date().toISOString().split('T')[0], createdAt: window.firebase.serverTimestamp()
            });
            logDebug(`Hydrated +${amount}ml`);
        }

        function initChart() {
            const ctx = document.getElementById('calorieChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Daily Calories', data: [], backgroundColor: '#10b981', borderRadius: 6 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } }, 
                        x: { grid: { display: false } } 
                    }
                }
            });
        }

        function updateChart(historyData) {
            if (!chartInstance) return;
            const labels = [];
            const values = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const k = d.toISOString().split('T')[0];
                labels.push(d.toLocaleDateString([], { weekday: 'short' }));
                values.push(historyData[k] || 0);
            }
            chartInstance.data.labels = labels;
            chartInstance.data.datasets[0].data = values;
            chartInstance.update();
        }

        function renderFeed(items) {
            const feed = document.getElementById('activityFeed');
            if(items.length === 0) {
                feed.innerHTML = '<p class="text-xs text-slate-400 text-center py-10 italic">No meals logged today</p>';
                return;
            }
            items.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            feed.innerHTML = items.map(i => `
                <div class="p-3 bg-white dark:bg-slate-700 shadow-sm border border-slate-100 dark:border-slate-600 rounded-xl flex justify-between items-center transition hover:border-emerald-200">
                    <div class="flex flex-col">
                        <span class="text-sm font-bold">${i.name}</span>
                        <span class="text-[10px] text-slate-400">${i.createdAt ? new Date(i.createdAt.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : 'Just now'}</span>
                    </div>
                    <span class="text-sm font-black text-emerald-600 bg-emerald-50 dark:bg-emerald-900/30 px-2 py-1 rounded-lg">${i.calories} <small>kcal</small></span>
                </div>
            `).join('');
        }

        window.onload = init;
    </script>
</body>
</html>
